<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Date Format Duplicates - Display Forecaster</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-top: 0; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #2563eb; }
        button:disabled { background: #94a3b8; cursor: not-allowed; }
        button.danger { background: #ef4444; }
        button.danger:hover { background: #dc2626; }
        .warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .success { background: #d1fae5; border-left-color: #10b981; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8fafc;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        .stat-card h3 { margin: 0 0 10px 0; font-size: 14px; color: #64748b; }
        .stat-card .value { font-size: 24px; font-weight: bold; color: #1e293b; }
        #output {
            margin-top: 20px;
            padding: 15px;
            background: #f8fafc;
            border-left: 4px solid #3b82f6;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Fix Date Format Duplicates</h1>

        <div class="warning">
            <strong>‚ö†Ô∏è Issue Found:</strong> Your database contains the same campaign data twice with different date formats:
            <ul>
                <li>US Format: <code>9/1/2025</code></li>
                <li>ISO Format: <code>2025-09-01</code></li>
            </ul>
            This causes spend to appear doubled! This tool will remove the ISO format duplicates and keep the US format records.
        </div>

        <div id="stats" class="stats" style="display: none;"></div>

        <div>
            <button onclick="analyzeDuplicates()" id="analyzeBtn">1. Analyze Date Format Duplicates</button>
            <button onclick="fixDuplicates()" id="fixBtn" class="danger" disabled>2. Remove ISO Format Duplicates</button>
            <button onclick="verifyResults()" id="verifyBtn" disabled>3. Verify Results</button>
        </div>

        <div id="output"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://znommdezzgrqbmpluukt.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpub21tZGV6emdycWJtcGx1dWt0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NDg4OTMsImV4cCI6MjA3MzIyNDg5M30.9a_uMi6o0kIP4ALGJf_H71viL680KJRtQvYqBsTpl24';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let isoFormatIds = [];

        function log(message) {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }

        // Normalize date to compare: convert both formats to comparable string
        function normalizeDate(dateStr) {
            // Try ISO format first (2025-09-01)
            const isoMatch = dateStr.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
            if (isoMatch) {
                const [, year, month, day] = isoMatch;
                return `${parseInt(month)}/${parseInt(day)}/${year}`;
            }
            // Already in US format (9/1/2025)
            return dateStr;
        }

        function isISOFormat(dateStr) {
            return /^\d{4}-\d{1,2}-\d{1,2}$/.test(dateStr);
        }

        async function analyzeDuplicates() {
            const btn = document.getElementById('analyzeBtn');
            btn.disabled = true;
            document.getElementById('output').textContent = '';
            document.getElementById('stats').style.display = 'none';
            isoFormatIds = [];

            log('üîç Analyzing database for date format duplicates...');

            try {
                // Load all data with pagination
                let allData = [];
                let page = 0;
                const pageSize = 1000;

                while (true) {
                    const { data, error } = await supabase
                        .from('campaign_data')
                        .select('id, date, campaign_order_name, spend')
                        .order('date', { ascending: true })
                        .range(page * pageSize, (page + 1) * pageSize - 1);

                    if (error) throw error;
                    if (!data || data.length === 0) break;

                    allData.push(...data);
                    if (data.length < pageSize) break;
                    page++;
                }

                log(`‚úÖ Loaded ${allData.length} total records`);

                // Group by normalized date + campaign
                const groups = {};
                allData.forEach(record => {
                    const normalizedDate = normalizeDate(record.date);
                    const key = `${normalizedDate}||${record.campaign_order_name}`;

                    if (!groups[key]) {
                        groups[key] = { us: [], iso: [] };
                    }

                    if (isISOFormat(record.date)) {
                        groups[key].iso.push(record);
                    } else {
                        groups[key].us.push(record);
                    }
                });

                // Find duplicates (records that exist in both formats)
                let duplicateCount = 0;
                let isoFormatCount = 0;
                let usFormatCount = 0;

                Object.values(groups).forEach(group => {
                    if (group.iso.length > 0 && group.us.length > 0) {
                        duplicateCount++;
                        // Mark ISO format records for deletion
                        group.iso.forEach(r => isoFormatIds.push(r.id));
                    }
                    isoFormatCount += group.iso.length;
                    usFormatCount += group.us.length;
                });

                log(`\nüìä Analysis Results:`);
                log(`   Total records: ${allData.length}`);
                log(`   US format records: ${usFormatCount}`);
                log(`   ISO format records: ${isoFormatCount}`);
                log(`   Date+Campaign combinations with BOTH formats: ${duplicateCount}`);
                log(`   ISO format records to delete: ${isoFormatIds.length}`);

                // Update stats display
                document.getElementById('stats').innerHTML = `
                    <div class="stat-card">
                        <h3>Total Records</h3>
                        <div class="value">${allData.length.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <h3>US Format (Keep)</h3>
                        <div class="value" style="color: #10b981">${usFormatCount.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <h3>ISO Format (Delete)</h3>
                        <div class="value" style="color: #ef4444">${isoFormatIds.length.toLocaleString()}</div>
                    </div>
                    <div class="stat-card">
                        <h3>After Cleanup</h3>
                        <div class="value">${(allData.length - isoFormatIds.length).toLocaleString()}</div>
                    </div>
                `;
                document.getElementById('stats').style.display = 'grid';

                if (isoFormatIds.length > 0) {
                    log(`\n‚ö†Ô∏è Ready to remove ${isoFormatIds.length} duplicate ISO format records.`);
                    log(`This will fix the 2x spend issue!`);
                    document.getElementById('fixBtn').disabled = false;
                } else {
                    log(`\n‚úÖ No date format duplicates found!`);
                }

            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
            } finally {
                btn.disabled = false;
            }
        }

        async function fixDuplicates() {
            if (!confirm(`Delete ${isoFormatIds.length} ISO format duplicate records?\n\nThis will keep US format (9/1/2025) and remove ISO format (2025-09-01).\n\nThis cannot be undone.`)) {
                return;
            }

            const btn = document.getElementById('fixBtn');
            btn.disabled = true;
            document.getElementById('output').textContent = '';

            log('üóëÔ∏è Deleting ISO format duplicate records...');

            try {
                let deletedCount = 0;
                const batchSize = 100;

                for (let i = 0; i < isoFormatIds.length; i += batchSize) {
                    const batch = isoFormatIds.slice(i, i + batchSize);

                    const { error } = await supabase
                        .from('campaign_data')
                        .delete()
                        .in('id', batch);

                    if (error) throw error;

                    deletedCount += batch.length;
                    log(`   Batch ${Math.floor(i/batchSize) + 1}: Deleted ${batch.length} records (${deletedCount}/${isoFormatIds.length})`);
                }

                log(`\n‚úÖ Successfully deleted ${deletedCount} ISO format duplicate records!`);
                log(`\nüéâ Your spend calculations should now be correct!`);
                document.getElementById('verifyBtn').disabled = false;

            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
            } finally {
                btn.disabled = false;
            }
        }

        async function verifyResults() {
            const btn = document.getElementById('verifyBtn');
            btn.disabled = true;
            document.getElementById('output').textContent = '';

            log('‚úÖ Verifying cleanup results...');

            try {
                const { count } = await supabase
                    .from('campaign_data')
                    .select('*', { count: 'exact', head: true });

                log(`üìä Database now contains ${count} records`);

                // Check for any remaining ISO format
                const { count: isoRemaining } = await supabase
                    .from('campaign_data')
                    .select('*', { count: 'exact', head: true })
                    .like('date', '%-%-%%');

                log(`   Remaining ISO format dates: ${isoRemaining || 0}`);

                if (isoRemaining === 0) {
                    log(`\n‚úÖ Success! All ISO format duplicates removed.`);
                    log(`\nüîÑ Please refresh your forecaster app to see corrected spend.`);
                } else {
                    log(`\n‚ö†Ô∏è Warning: ${isoRemaining} ISO format records still exist.`);
                }

            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
