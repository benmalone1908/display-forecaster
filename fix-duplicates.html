<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Duplicate Records - Display Forecaster</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-top: 0;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        #output {
            margin-top: 20px;
            padding: 15px;
            background: #f8fafc;
            border-left: 4px solid #3b82f6;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        .warning {
            background: #fef3c7;
            border-left-color: #f59e0b;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            border-left: 4px solid #f59e0b;
        }
        .success {
            background: #d1fae5;
            border-left-color: #10b981;
        }
        .error {
            background: #fee2e2;
            border-left-color: #ef4444;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8fafc;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #64748b;
        }
        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #1e293b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Fix Duplicate Records</h1>

        <div class="warning">
            <strong>‚ö†Ô∏è Warning:</strong> This will remove duplicate campaign data records, keeping only the most recent upload for each date/campaign combination.
        </div>

        <div id="stats" class="stats" style="display: none;">
            <div class="stat-card">
                <h3>Total Records</h3>
                <div class="value" id="totalRecords">-</div>
            </div>
            <div class="stat-card">
                <h3>Duplicate Records</h3>
                <div class="value" id="duplicateRecords">-</div>
            </div>
            <div class="stat-card">
                <h3>Records After Cleanup</h3>
                <div class="value" id="afterCleanup">-</div>
            </div>
        </div>

        <div>
            <button onclick="analyzeDatabase()" id="analyzeBtn">1. Analyze Database</button>
            <button onclick="fixDuplicates()" id="fixBtn" disabled>2. Fix Duplicates</button>
            <button onclick="verifyResults()" id="verifyBtn" disabled>3. Verify Results</button>
        </div>

        <div id="output"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://znommdezzgrqbmpluukt.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpub21tZGV6emdycWJtcGx1dWt0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NDg4OTMsImV4cCI6MjA3MzIyNDg5M30.9a_uMi6o0kIP4ALGJf_H71viL680KJRtQvYqBsTpl24';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let duplicateCount = 0;

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${message}\n`;
            output.scrollTop = output.scrollHeight;

            if (type === 'error') {
                output.className = 'error';
            } else if (type === 'success') {
                output.className = 'success';
            }
        }

        async function analyzeDatabase() {
            const btn = document.getElementById('analyzeBtn');
            btn.disabled = true;
            document.getElementById('output').textContent = '';
            document.getElementById('stats').style.display = 'none';

            log('üîç Analyzing database for duplicates...');

            try {
                // Get all records
                const { data: allRecords, error } = await supabase
                    .from('campaign_data')
                    .select('id, date, campaign_order_name, uploaded_at')
                    .order('uploaded_at', { ascending: false });

                if (error) throw error;

                log(`‚úÖ Found ${allRecords.length} total records`);

                // Group by date+campaign to find duplicates
                const recordMap = new Map();
                const duplicates = [];

                for (const record of allRecords) {
                    const key = `${record.date}::${record.campaign_order_name}`;

                    if (!recordMap.has(key)) {
                        recordMap.set(key, [record]);
                    } else {
                        recordMap.get(key).push(record);
                        duplicates.push(record);
                    }
                }

                duplicateCount = duplicates.length;
                const uniqueCombinations = recordMap.size;
                const duplicateCombinations = Array.from(recordMap.values()).filter(records => records.length > 1).length;

                log(`üìä Analysis complete:`);
                log(`   - Total records: ${allRecords.length}`);
                log(`   - Unique date/campaign combinations: ${uniqueCombinations}`);
                log(`   - Combinations with duplicates: ${duplicateCombinations}`);
                log(`   - Duplicate records to remove: ${duplicateCount}`);

                // Show stats
                document.getElementById('totalRecords').textContent = allRecords.length;
                document.getElementById('duplicateRecords').textContent = duplicateCount;
                document.getElementById('afterCleanup').textContent = allRecords.length - duplicateCount;
                document.getElementById('stats').style.display = 'grid';

                if (duplicateCount > 0) {
                    log(`\n‚ö†Ô∏è Found ${duplicateCount} duplicate records. Click "Fix Duplicates" to remove them.`, 'info');
                    document.getElementById('fixBtn').disabled = false;
                } else {
                    log(`\n‚úÖ No duplicates found! Database is clean.`, 'success');
                }

            } catch (error) {
                log(`‚ùå Error analyzing database: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
            }
        }

        async function fixDuplicates() {
            if (!confirm(`Remove ${duplicateCount} duplicate records? This cannot be undone.`)) {
                return;
            }

            const btn = document.getElementById('fixBtn');
            btn.disabled = true;
            document.getElementById('output').textContent = '';

            log('üîß Starting duplicate removal...');

            try {
                // Get all records ordered by uploaded_at (newest first)
                const { data: allRecords, error: fetchError } = await supabase
                    .from('campaign_data')
                    .select('id, date, campaign_order_name, uploaded_at')
                    .order('uploaded_at', { ascending: false });

                if (fetchError) throw fetchError;

                // Find duplicates (keep newest)
                const recordMap = new Map();
                const duplicatesToDelete = [];

                for (const record of allRecords) {
                    const key = `${record.date}::${record.campaign_order_name}`;

                    if (!recordMap.has(key)) {
                        recordMap.set(key, record);
                    } else {
                        duplicatesToDelete.push(record.id);
                    }
                }

                log(`üóëÔ∏è Deleting ${duplicatesToDelete.length} duplicate records...`);

                // Delete in batches
                let removedCount = 0;
                const batchSize = 100;

                for (let i = 0; i < duplicatesToDelete.length; i += batchSize) {
                    const batch = duplicatesToDelete.slice(i, i + batchSize);

                    const { error: deleteError } = await supabase
                        .from('campaign_data')
                        .delete()
                        .in('id', batch);

                    if (deleteError) throw deleteError;

                    removedCount += batch.length;
                    log(`   Batch ${Math.floor(i/batchSize) + 1}: Deleted ${batch.length} records (${removedCount}/${duplicatesToDelete.length})`);
                }

                log(`\n‚úÖ Successfully removed ${removedCount} duplicate records!`, 'success');
                document.getElementById('verifyBtn').disabled = false;

            } catch (error) {
                log(`‚ùå Error fixing duplicates: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
            }
        }

        async function verifyResults() {
            const btn = document.getElementById('verifyBtn');
            btn.disabled = true;
            document.getElementById('output').textContent = '';

            log('‚úÖ Verifying cleanup results...');

            try {
                const { count, error } = await supabase
                    .from('campaign_data')
                    .select('*', { count: 'exact', head: true });

                if (error) throw error;

                log(`üìä Database now contains ${count} records`);

                // Re-run analysis
                await analyzeDatabase();

            } catch (error) {
                log(`‚ùå Error verifying results: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
